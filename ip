#!/bin/bash
set -e

# Tool made by Lokesh Kumar
# Updated by Gemini for Multi-OS support and security

# --- Define Colors ---
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[93m'
CYAN='\033[96m'
MAGENTA='\033[95m'
BLUE='\033[94m'
RESET='\033[0m'

# --- Define Paths ---
SAVE_DIR="$HOME/IP_Scanner_Results"
INSTALL_DIR="$HOME/.ipscanner"
CONFIG_DIR="$HOME/.config/ipscanner"
CONFIG_FILE="$CONFIG_DIR/config"
ACCESS_TOKEN=""

# --- [SECURITY FIX] Load API Key ---
if [ -f "$CONFIG_FILE" ]; then
    ACCESS_TOKEN=$(grep 'ACCESS_TOKEN=' "$CONFIG_FILE" | cut -d'=' -f2)
fi

# Exit if token is not found or is the default placeholder
if [ -z "$ACCESS_TOKEN" ] || [ "$ACCESS_TOKEN" == "YOUR_KEY_HERE" ]; then
    echo -e "${RED}Error: ipinfo.io API Token not found!${RESET}"
    echo -e "${YELLOW}Please create the ${CONFIG_FILE} file and add:${RESET}"
    echo -e "${CYAN}ACCESS_TOKEN=YOUR_KEY${RESET}"
    exit 1
fi

# --- Function to display the banner ---
display_banner() {
    clear
    echo -e "${CYAN}"
    figlet -f slant "IP Scanner Pro" | lolcat
    echo -e "${GREEN}By Lokesh Kumar${RESET}"
    echo -e "${MAGENTA}---------------------------------${RESET}"
    echo -e "${YELLOW}Advanced IP Scanning Tool${RESET}"
    echo -e "${MAGENTA}---------------------------------${RESET}"
}

# --- Function to fetch and display IP details ---
fetch_ip_details() {
    local ip_address=$1
    local result

    echo -e "${YELLOW}Fetching IP details...${RESET}"
    
    # Use Python to fetch IP details (Passing API Key as a variable)
    result=$(python3 - <<END
import requests
import json
import sys

access_token = "$ACCESS_TOKEN"
ip_address = "$ip_address"
url = f"https://ipinfo.io/{ip_address}/json?token={access_token}"

try:
    response = requests.get(url, timeout=5)
    response.raise_for_status()
    details = response.json()
    print(json.dumps(details))
except requests.exceptions.HTTPError as e:
    # Provide more specific error messages
    if e.response.status_code == 404:
        print(json.dumps({"error": "IP address not found or private."}))
    elif e.response.status_code == 401 or e.response.status_code == 403:
        print(json.dumps({"error": "Invalid API Token. Check $CONFIG_FILE"}))
    else:
        print(json.dumps({"error": f"API Error: {e.response.status_code}"}))
except requests.RequestException as e:
    print(json.dumps({"error": "Failed to connect. Check internet."}))
    sys.exit(1)
END
)
  
    # Check if the request was successful
    if echo "$result" | jq -e '.error' > /dev/null; then
        error_msg=$(echo "$result" | jq -r '.error')
        echo -e "${RED}Failed to fetch details: $error_msg${RESET}"
        return
    fi

    # [IMPROVEMENT] Save formatted output
    formatted_output=$(echo "$result" | jq -r '
        "IP Address: \(.ip // "N/A")",
        "Hostname: \(.hostname // "N/A")",
        "City: \(.city // "N/A")",
        "Region: \(.region // "N/A")",
        "Country: \(.country // "N/A")",
        "Location: \(.loc // "N/A")",
        "Organization: \(.org // "N/A")",
        "Postal Code: \(.postal // "N/A")",
        "Timezone: \(.timezone // "N/A")"
    ')

    # Print to screen with colors
    echo -e "${GREEN}--- IP Address Details ---${RESET}"
    echo "$formatted_output" | while IFS= read -r line; do
        echo -e "${CYAN}$line${RESET}"
    done
    echo -e "${GREEN}----------------------------${RESET}"

    # [IMPROVEMENT] Save details to file (formatted text + raw JSON)
    mkdir -p "$SAVE_DIR"
    filename="$SAVE_DIR/${ip_address}_Report.txt"
    
    echo "--- IP Address Details ---" > "$filename"
    echo "$formatted_output" >> "$filename"
    echo "----------------------------" >> "$filename"
    echo "\n--- Raw JSON Data ---" >> "$filename"
    echo "$result" | jq . >> "$filename"

    echo -e "${GREEN}Details saved to: ${filename}${RESET}"
}

# --- [IMPROVEMENT] Function to update the tool ---
update_tool() {
    echo -e "${BLUE}Updating tool from GitHub...${RESET}"
    if [ -d "$INSTALL_DIR/.git" ]; then
        cd "$INSTALL_DIR"
        git pull origin main # Assuming 'main' branch
        echo -e "${GREEN}Update complete.${RESET}"
        
        # Copy the updated script back to the bin directory
        echo -e "${YELLOW}Applying updates...${RESET}"
        if [[ $(uname -o) == "Android" ]]; then
            BIN_DIR="$PREFIX/bin"
            cp "ip" "$BIN_DIR/ip"
            chmod +x "$BIN_DIR/ip"
        else
            BIN_DIR="/usr/local/bin"
            if command -v sudo &> /dev/null; then
                sudo cp "ip" "$BIN_DIR/ip"
                sudo chmod +x "$BIN_DIR/ip"
            else
                # If sudo is not found, assume root
                cp "ip" "$BIN_DIR/ip"
                chmod +x "$BIN_DIR/ip"
            fi
        fi
        echo -e "${GREEN}Tool updated. Please restart the script.${RESET}"
    else
        echo -e "${RED}Installation directory $INSTALL_DIR not found.${RESET}"
        echo -e "${YELLOW}Please reinstall using the installer script.${RESET}"
    fi
    sleep 3
}

# --- [IMPROVEMENT] Function to remove the tool ---
remove_tool() {
    echo -e "${RED}Completely removing the tool...${RESET}"
    SUDO_CMD="sudo"
    
    if [[ $(uname -o) == "Android" ]]; then
        BIN_DIR="$PREFIX/bin"
        SUDO_CMD=""
    elif [[ -f /etc/debian_version ]] || [[ -f /etc/arch-release ]] || [[ -f /etc/fedora-release ]] || [[ $(uname -s) == "Darwin" ]]; then
        BIN_DIR="/usr/local/bin"
    fi

    # Remove executable
    if [ -f "$BIN_DIR/ip" ]; then
        $SUDO_CMD rm -f "$BIN_DIR/ip"
        echo "Executable removed."
    fi
    
    # Remove cloned repo
    if [ -d "$INSTALL_DIR" ]; then
        rm -rf "$INSTALL_DIR"
        echo "Repository removed."
    fi

    # Remove config file
    if [ -d "$CONFIG_DIR" ]; then
        rm -rf "$CONFIG_DIR"
        echo "Config file removed."
    fi

    # Remove saved results
    if [ -d "$SAVE_DIR" ]; then
        rm -rf "$SAVE_DIR"
        echo "Scan results removed."
    fi

    echo -e "${GREEN}Tool removed successfully!${RESET}"
}

# --- Function to display the main menu ---
main_menu() {
    while true; do
        display_banner
        
        # Fetch and display user IP information
        ipv4=$(curl -s -4 ifconfig.me)
        ipv6=$(curl -s ifconfig.me)
        echo -e "${RED}Your IPv4: ${CYAN}$ipv4${RESET}"
        echo -e "${RED}Your IPv6: ${CYAN}$ipv6${RESET}"
        
        echo -e "${MAGENTA}\nMain Menu:${RESET}"
        echo -e "${CYAN}1. Scan IPv4 / IPv6${RESET}"
        echo -e "${CYAN}2. Update Tool${RESET}"
        echo -e "${CYAN}3. Remove Tool${RESET}"
        echo -e "${CYAN}4. Exit${RESET}"

        # --- FIX (SC1073) ---
        # Removed the complex $(echo -e ...) wrapper
        read -p "${YELLOW}Enter your choice: ${RESET}" choice

        case $choice in
            1)
                # --- FIX (SC1073) ---
                # Removed the complex $(echo -e ...) wrapper
                read -p "${YELLOW}Enter the IP address (v4 or v6): ${RESET}" ip_address
                
                # [SECURITY FIX] Basic validation to prevent command injection
                if [[ "$ip_address" == *[';' '|' '&' '$' '(' ')' '`']* ]]; then
                    echo -e "${RED}Invalid characters in IP address.${RESET}"
                    sleep 2
                    continue
                fi
                fetch_ip_details "$ip_address"
                ;;
            2)
                update_tool
                ;;
            3)
                remove_tool
                exit 0
                ;;
            4)
                echo -e "${RED}Exiting...${RESET}"
                exit 0
                ;;
            *)
                echo -e "${RED}Invalid choice, please try again.${RESET}"
                sleep 1
                ;;
        esac
        echo -e "\n${YELLOW}Press Enter to continue...${RESET}"
        read
    done
}

# Run the script
main_menu
